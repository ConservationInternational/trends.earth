name: Build documentation PDFs

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'tasks.py'
      - 'requirements-dev.txt'
      - 'LDMP/metadata.txt'
      - '.readthedocs.yaml'
      - '.github/workflows/build_docs_pdfs.yaml'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - 'tasks.py'
      - 'requirements-dev.txt'
      - 'LDMP/metadata.txt'
      - '.readthedocs.yaml'
      - '.github/workflows/build_docs_pdfs.yaml'
  schedule:
    - cron: "0 5 * * 1,4"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build_docs_pdfs:
    name: Build documentation PDFs
    runs-on: ubuntu-latest
    env:
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
      - name: Setup python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          architecture: "x64"
          cache: pip
      - run: pip install -r requirements-dev.txt
      - name: Install Playwright Chromium
        run: python -m playwright install --with-deps chromium
      - name: Docs pre-build
        run: invoke rtd-pre-build
      - name: Build PDF and push to S3
        if: github.event_name != 'pull_request'
        run: invoke docs-build --pdf --upload
      - name: Build PDF (PR validation)
        if: github.event_name == 'pull_request'
        run: invoke docs-build --pdf
